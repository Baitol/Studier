version: '3.8'   # Версія Docker Compose, яку використовуємо

services:        # Початок списку контейнерів

  # -------------------------------
  # PHP-FPM контейнер (Laravel backend)
  # -------------------------------
  backend:
    build:       # Налаштування для збірки Docker image
      context: backend           # Корінь проекту — тут шукається Dockerfile
      dockerfile: Dockerfile     # Вказуємо конкретний Dockerfile у папці backend
    container_name: studier-php  # Назва контейнера (зручно для exec/logs)
    volumes:
      - ./backend:/var/www/html  # Мапимо бекенд-код у контейнер у /var/www/html
    working_dir: /var/www/html   # Встановлюємо робочу директорію всередині контейнера
    depends_on:
      - db                       # Цей контейнер запускатиметься лише після MySQL
    ports:
      - "9000:9000"              # Відкриваємо порт PHP-FPM, щоб Nginx міг до нього підключитись
    command: sh -c "php artisan migrate --force && php-fpm"
                                 # Виконуємо міграції при запуску, потім стартує PHP-FPM

  # -------------------------------
  # Nginx — вебсервер
  # -------------------------------
  nginx:
    image: nginx:1.25           # Використовуємо офіційний образ Nginx
    container_name: studier-nginx  # Назва контейнера
    ports:
      - "8000:80"               # Порт 8000 → Nginx 80 порт. Сайт відкривається на localhost:8000
    volumes:
      - ./backend:/var/www/html               # Laravel-код доступний Nginx
      - ./backend/default.conf:/etc/nginx/conf.d/default.conf
                                   # Підсовуємо свій конфіг Nginx у контейнер
    depends_on:
      - backend                     # Спочатку PHP-FPM, потім Nginx

  # -------------------------------
  # MySQL база даних
  # -------------------------------
  db:
    image: mysql:9.0            # Образ MySQL (попередження: 9.0 — ще "майбутня" версія)
    container_name: studier-mysql  # Назва контейнера
    environment:                # Змінні середовища для конфігурації MySQL
      MYSQL_ROOT_PASSWORD: root      # Пароль root
      MYSQL_DATABASE: studier        # База, яка створиться автоматично
      MYSQL_USER: user               # Ім'я звичайного користувача
      MYSQL_PASSWORD: password       # Пароль для MySQL_USER
    ports:
      - "3306:3306"             # Доступ до MySQL із хоста
    volumes:
      - db_data:/var/lib/mysql  # Постійне збереження бази (volume)

  # -------------------------------
  # phpMyAdmin — веб інтерфейс для MySQL
  # -------------------------------
  phpmyadmin:
    image: phpmyadmin/phpmyadmin       # Офіційний образ phpMyAdmin
    container_name: studier-phpmyadmin # Назва контейнера
    environment:
      PMA_HOST: db                 # Хост бази — назва контейнера MySQL
      PMA_USER: root               # Логін для підключення
      PMA_PASSWORD: root           # Пароль для root
    ports:
      - "8080:80"                  # phpMyAdmin доступний на localhost:8080
    depends_on:
      - db                         # Запуск тільки після MySQL

  # -------------------------------
  # React + Vite (Frontend)
  # -------------------------------
  frontend:
    image: node:20                # Образ Node.js для запуску React
    container_name: studier-react # Назва контейнера
    working_dir: /app             # Робоча директорія в контейнері
    volumes:
      - ./frontend:/app           # Мапимо фронтенд проект у контейнер
    ports:
      - "5173:5173"               # Vite Dev Server доступний на localhost:5173
    command: sh -c "npm install && npm run dev"
                                  # Встановлюємо залежності та запускаємо Vite у dev-режимі
    depends_on:
      - backend                     # Спочатку PHP-FPM, потім Nginx
volumes:
  db_data:                         # Volume для збереження MySQL даних
